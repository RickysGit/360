<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>360°相簿</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5/index.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/three/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/little-planet-adapter@5/index.min.js"></script>

    <style>
        :root { --primary: #007AFF; --danger: #FF3B30; --bg: #f2f2f7; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); color: #1c1c1e; overflow-x: hidden; }
        
        /* 列表介面樣式 */
        #gallery-view { padding: 20px; max-width: 1000px; margin: auto; padding-bottom: 80px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 10px; flex-wrap: wrap; gap: 10px; }
        .header-btns { display: flex; gap: 10px; }
        
        .upload-btn { background: var(--primary); color: white; border: none; padding: 10px 18px; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .manage-btn { background: #e5e5ea; color: #007AFF; border: none; padding: 10px 18px; border-radius: 10px; font-weight: 600; cursor: pointer; }
        .delete-btn { background: var(--danger); color: white; border: none; padding: 10px 18px; border-radius: 10px; font-weight: 600; cursor: pointer; display: none; }

        .month-group { margin-bottom: 35px; }
        .month-title { font-size: 22px; font-weight: 700; margin-bottom: 15px; color: #3a3a3c; border-left: 5px solid var(--primary); padding-left: 12px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; }
        
        /* 縮圖卡片 */
        .thumb-card { background: white; border-radius: 14px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); cursor: pointer; position: relative; transition: 0.2s; }
        .thumb-card img { width: 100%; height: 110px; object-fit: cover; display: block; pointer-events: none; }
        .thumb-info { padding: 10px; font-size: 12px; color: #8e8e93; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* 選取模式樣式 */
        .select-overlay { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; background: rgba(0,0,0,0.2); display: none; z-index: 5; }
        .thumb-card.selected .select-overlay { background: var(--primary); border-color: var(--primary); }
        .thumb-card.selected .select-overlay::after { content: '✓'; color: white; display: flex; justify-content: center; align-items: center; font-size: 16px; font-weight: bold; height: 100%; }
        .manage-mode .select-overlay { display: block; }
        .manage-mode .thumb-card:hover { transform: none; }

        /* 360 閱覽器 */
        #viewer-container { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 2000; }
        #panorama { width: 100%; height: 100%; }
        
        .overlay-ui { position: absolute; z-index: 2001; transition: opacity 0.3s ease, transform 0.3s ease; }
        .overlay-ui.hidden { opacity: 0; pointer-events: none; transform: translateY(10px); }
        
        #btn-back { top: 50px; left: 20px; background: rgba(0,0,0,0.6); color: white; border: none; padding: 12px 20px; border-radius: 25px; backdrop-filter: blur(15px); cursor: pointer; }
        #btn-download { top: 50px; right: 20px; background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 25px; font-weight: 600; cursor: pointer; }
        
        .nav-controls { bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; gap: 60px; }
        .nav-btn { background: rgba(255,255,255,0.25); color: white; border: 1px solid rgba(255,255,255,0.4); width: 64px; height: 64px; border-radius: 50%; font-size: 24px; backdrop-filter: blur(15px); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="gallery-view">
    <div class="header">
        <h1>360° 相簿</h1>
        <div class="header-btns">
            <button class="manage-btn" id="manage-toggle">管理</button>
            <button class="delete-btn" id="delete-selected">刪除選取</button>
            <button class="upload-btn" id="upload-trigger">＋ 上傳圖</button>
        </div>
        <input type="file" id="file-input" accept="image/*" style="display: none;">
    </div>
    <div id="album-list"></div>
</div>

<div id="viewer-container">
    <div id="panorama"></div>
    <button id="btn-back" class="overlay-ui">← 返回列表</button>
    <button id="btn-download" class="overlay-ui">擷取當前畫面</button>
    
    <div class="nav-controls overlay-ui">
        <button class="nav-btn" id="prev-btn">❮</button>
        <button class="nav-btn" id="next-btn">❯</button>
    </div>
</div>

<script>
    let db;
    let currentImages = [];
    let currentIndex = 0;
    let viewer = null;
    let uiVisible = true;
    let isManageMode = false;
    let selectedIds = new Set();

    // 1. 初始化 IndexedDB
    const request = indexedDB.open("ProPanoGallery_V3", 1);
    request.onupgradeneeded = e => {
        db = e.target.result;
        db.createObjectStore("photos", { keyPath: "id", autoIncrement: true });
    };
    request.onsuccess = e => {
        db = e.target.result;
        loadPhotos();
    };

    // 2. 檔案上傳
    document.getElementById('upload-trigger').onclick = () => document.getElementById('file-input').click();
    document.getElementById('file-input').addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = event => {
            const now = new Date();
            const photoData = {
                name: file.name,
                data: event.target.result,
                timestamp: now.getTime(),
                monthKey: `${now.getFullYear()}年${now.getMonth() + 1}月`
            };
            const tx = db.transaction("photos", "readwrite");
            tx.objectStore("photos").add(photoData);
            tx.oncomplete = () => loadPhotos();
        };
        reader.readAsDataURL(file);
    });

    // 3. 讀取與渲染清單
    function loadPhotos() {
        const tx = db.transaction("photos", "readonly");
        tx.objectStore("photos").getAll().onsuccess = e => {
            currentImages = e.target.result.sort((a,b) => b.timestamp - a.timestamp);
            renderGallery();
        };
    }

    function renderGallery() {
        const listDiv = document.getElementById('album-list');
        listDiv.innerHTML = "";
        const groups = {};

        currentImages.forEach((img, idx) => {
            if (!groups[img.monthKey]) groups[img.monthKey] = [];
            groups[img.monthKey].push({ ...img, idx });
        });

        for (const month in groups) {
            const section = document.createElement('div');
            section.className = 'month-group';
            section.innerHTML = `<div class="month-title">${month}</div><div class="grid"></div>`;
            const grid = section.querySelector('.grid');

            groups[month].forEach(photo => {
                const card = document.createElement('div');
                card.className = `thumb-card ${selectedIds.has(photo.id) ? 'selected' : ''}`;
                card.innerHTML = `<div class="select-overlay"></div><img src="${photo.data}"><div class="thumb-info">${photo.name}</div>`;
                
                card.onclick = () => {
                    if (isManageMode) {
                        toggleSelect(photo.id, card);
                    } else {
                        openViewer(photo.idx);
                    }
                };
                grid.appendChild(card);
            } );
            listDiv.appendChild(section);
        }
    }

    // 4. 管理功能（選取與刪除）
    document.getElementById('manage-toggle').onclick = function() {
        isManageMode = !isManageMode;
        this.innerText = isManageMode ? "取消" : "管理";
        this.style.background = isManageMode ? "#8e8e93" : "#e5e5ea";
        this.style.color = isManageMode ? "white" : "#007AFF";
        document.getElementById('delete-selected').style.display = isManageMode ? "block" : "none";
        document.getElementById('gallery-view').classList.toggle('manage-mode', isManageMode);
        if (!isManageMode) {
            selectedIds.clear();
            renderGallery();
        }
    };

    function toggleSelect(id, element) {
        if (selectedIds.has(id)) {
            selectedIds.delete(id);
            element.classList.remove('selected');
        } else {
            selectedIds.add(id);
            element.classList.add('selected');
        }
        document.getElementById('delete-selected').innerText = `刪除選取 (${selectedIds.size})`;
    }

    document.getElementById('delete-selected').onclick = () => {
        if (selectedIds.size === 0) return;
        if (!confirm(`確定要刪除這 ${selectedIds.size} 張照片嗎？`)) return;

        const tx = db.transaction("photos", "readwrite");
        const store = tx.objectStore("photos");
        selectedIds.forEach(id => store.delete(id));
        tx.oncomplete = () => {
            selectedIds.clear();
            isManageMode = false;
            document.getElementById('manage-toggle').click();
            loadPhotos();
        };
    };

    // 5. 360 核心控制
    function openViewer(index) {
        currentIndex = index;
        document.getElementById('gallery-view').style.display = 'none';
        document.getElementById('viewer-container').style.display = 'block';
        uiVisible = true;
        toggleUI();

        setTimeout(() => {
            if (!viewer) {
                initPSV(currentImages[currentIndex].data);
            } else {
                viewer.setPanorama(currentImages[currentIndex].data).then(() => {
                    viewer.animate({ zoom: 30, speed: '1s' });
                });
            }
        }, 100); 
    }

    function initPSV(imageSrc) {
        viewer = new PhotoSphereViewer.Viewer({
            container: 'panorama',
            adapter: [PhotoSphereViewer.LittlePlanetAdapter],
            panorama: imageSrc,

            mousewheel: true,
            mousewheelSpeed: 2,

            minFov: 1,
            maxFov: 170,
            defaultZoomLvl: 30,
            fisheye: 2,
            navbar: false,

            // ✅ PSV v5 正確選項：rendererParameters（Three.js WebGLRendererParameters）
            //    用 preserveDrawingBuffer 才能穩定截圖（避免 WebGL frame buffer 每幀被清掉）
            rendererParameters: {
                alpha: true,
                antialias: true,
                preserveDrawingBuffer: true
            }
        });

        viewer.addEventListener('click', () => {
            uiVisible = !uiVisible;
            toggleUI();
        });
    }

    function toggleUI() {
        document.querySelectorAll('.overlay-ui').forEach(el => el.classList.toggle('hidden', !uiVisible));
    }

    // ===== 6. 截圖功能（修復版） =====
    function pickPsvCanvas() {
        // 優先抓 PSV 內部真正的 renderer canvas（有些版本內部結構不同，所以做多重 fallback）
        const maybe =
            viewer?.renderer?.renderer?.domElement ||
            viewer?.renderer?.renderer?.canvas ||
            null;

        if (maybe && typeof maybe.toDataURL === 'function') return maybe;

        const canvases = document.querySelectorAll('#panorama canvas');
        // 取最後一個通常比較像 WebGL 主畫面（保守做法：挑有尺寸者）
        for (let i = canvases.length - 1; i >= 0; i--) {
            const c = canvases[i];
            if ((c.width > 0 && c.height > 0) && typeof c.toDataURL === 'function') return c;
        }
        return null;
    }

    function downloadBlob(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1200);
    }

    function downloadDataUrl(dataUrl, filename) {
        const a = document.createElement('a');
        a.href = dataUrl;
        a.download = filename; // iOS Safari 可能忽略 download，但至少會開圖
        document.body.appendChild(a);
        a.click();
        a.remove();
    }

    async function nextPaint() {
        // 連續兩次 RAF：更高機率確保 WebGL 已完成本幀渲染
        await new Promise(r => requestAnimationFrame(() => r()));
        await new Promise(r => requestAnimationFrame(() => r()));
    }

    document.getElementById('btn-download').onclick = async (evt) => {
        evt.preventDefault();
        evt.stopPropagation();

        if (!viewer) {
            alert("尚未初始化 viewer");
            return;
        }

        const c = pickPsvCanvas();
        if (!c) {
            alert("找不到 PSV 的 canvas");
            return;
        }

        const filename = `360_Capture_${Date.now()}.png`;

        try {
            await nextPaint();

            // 優先用 toBlob：省記憶體、手機較穩
            if (c.toBlob) {
                c.toBlob((blob) => {
                    if (!blob) {
                        // toBlob 偶發回 null（特別是某些 iOS WebGL 情況）→ fallback toDataURL
                        try {
                            const dataUrl = c.toDataURL('image/png');
                            downloadDataUrl(dataUrl, filename);
                        } catch (e2) {
                            console.error(e2);
                            alert("截圖失敗（toBlob=null 且 toDataURL 也失敗）");
                        }
                        return;
                    }
                    downloadBlob(blob, filename);
                }, 'image/png');
            } else {
                // fallback：舊瀏覽器
                const dataUrl = c.toDataURL('image/png');
                downloadDataUrl(dataUrl, filename);
            }
        } catch (e) {
            console.error(e);
            // 如果是跨域或 WebGL buffer 問題，這裡會比較明顯
            alert("截圖失敗：" + (e?.message || e));
        }
    };

    // 返回與切換
    document.getElementById('btn-back').onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('gallery-view').style.display = 'block';
        document.getElementById('viewer-container').style.display = 'none';
    };

    document.getElementById('prev-btn').onclick = (e) => {
        e.stopPropagation();
        if (currentIndex < currentImages.length - 1) {
            currentIndex++;
            viewer.setPanorama(currentImages[currentIndex].data);
        }
    };

    document.getElementById('next-btn').onclick = (e) => {
        e.stopPropagation();
        if (currentIndex > 0) {
            currentIndex--;
            viewer.setPanorama(currentImages[currentIndex].data);
        }
    };
</script>

</body>
</html>
