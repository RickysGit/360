<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>360°相簿</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5/index.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/three/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/little-planet-adapter@5/index.min.js"></script>

    <style>
        :root { --primary: #007AFF; --bg: #f2f2f7; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); color: #1c1c1e; }
        
        /* 列表介面 */
        #gallery-view { padding: 20px; max-width: 1000px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 10px; }
        .upload-btn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .upload-btn:active { opacity: 0.7; }
        
        .month-group { margin-bottom: 35px; }
        .month-title { font-size: 22px; font-weight: 700; margin-bottom: 15px; color: #3a3a3c; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; }
        .thumb-card { background: white; border-radius: 14px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); cursor: pointer; }
        .thumb-card img { width: 100%; height: 110px; object-fit: cover; display: block; }
        .thumb-info { padding: 10px; font-size: 12px; color: #8e8e93; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* 閱讀器介面 */
        #viewer-container { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; z-index: 2000; }
        #panorama { width: 100%; height: 100%; }
        
        .overlay-ui { position: absolute; z-index: 2001; transition: opacity 0.3s ease, transform 0.3s ease; }
        .overlay-ui.hidden { opacity: 0; pointer-events: none; transform: translateY(-10px); }
        
        #btn-back { top: env(safe-area-inset-top, 30px); left: 20px; background: rgba(0,0,0,0.5); color: white; border: none; padding: 10px 18px; border-radius: 20px; backdrop-filter: blur(10px); cursor: pointer; }
        #btn-download { top: env(safe-area-inset-top, 30px); right: 20px; background: var(--primary); color: white; border: none; padding: 10px 18px; border-radius: 20px; font-weight: 600; cursor: pointer; }
        
        .nav-controls { bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 40px; }
        .nav-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); width: 56px; height: 56px; border-radius: 50%; font-size: 20px; backdrop-filter: blur(15px); cursor: pointer; }

        /* 自定義 Loading 樣式 */
        .psv-loader { color: var(--primary) !important; }
    </style>
</head>
<body>

<div id="gallery-view">
    <div class="header">
        <h1>我的全景圖</h1>
        <button class="upload-btn" onclick="document.getElementById('file-input').click()">上傳相片</button>
        <input type="file" id="file-input" accept="image/*" style="display: none;">
    </div>
    <div id="album-list"></div>
</div>

<div id="viewer-container">
    <div id="panorama"></div>
    <button id="btn-back" class="overlay-ui">← 返回列表</button>
    <button id="btn-download" class="overlay-ui">下載畫面</button>
    
    <div class="nav-controls overlay-ui">
        <button class="nav-btn" id="prev-btn">❮</button>
        <button class="nav-btn" id="next-btn">❯</button>
    </div>
</div>

<script>
    let db;
    let currentImages = [];
    let currentIndex = 0;
    let viewer = null;
    let uiVisible = true;

    // 1. 初始化資料庫
    const request = indexedDB.open("StablePanoDB", 1);
    request.onupgradeneeded = e => {
        db = e.target.result;
        db.createObjectStore("photos", { keyPath: "id", autoIncrement: true });
    };
    request.onsuccess = e => {
        db = e.target.result;
        loadPhotos();
    };

    // 2. 處理上傳
    document.getElementById('file-input').addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = event => {
            const now = new Date();
            const photoData = {
                name: file.name,
                data: event.target.result,
                timestamp: now.getTime(),
                monthKey: `${now.getFullYear()}年${now.getMonth() + 1}月`
            };
            const tx = db.transaction("photos", "readwrite");
            tx.objectStore("photos").add(photoData);
            tx.oncomplete = () => loadPhotos();
        };
        reader.readAsDataURL(file);
    });

    function loadPhotos() {
        const tx = db.transaction("photos", "readonly");
        tx.objectStore("photos").getAll().onsuccess = e => {
            currentImages = e.target.result.sort((a,b) => b.timestamp - a.timestamp);
            renderGallery();
        };
    }

    function renderGallery() {
        const listDiv = document.getElementById('album-list');
        listDiv.innerHTML = "";
        const groups = {};

        currentImages.forEach((img, idx) => {
            if (!groups[img.monthKey]) groups[img.monthKey] = [];
            groups[img.monthKey].push({ ...img, idx });
        });

        for (const month in groups) {
            const section = document.createElement('div');
            section.className = 'month-group';
            section.innerHTML = `<div class="month-title">${month}</div><div class="grid"></div>`;
            const grid = section.querySelector('.grid');

            groups[month].forEach(photo => {
                const card = document.createElement('div');
                card.className = 'thumb-card';
                card.innerHTML = `<img src="${photo.data}"><div class="thumb-info">${photo.name}</div>`;
                card.onclick = () => openViewer(photo.idx);
                grid.appendChild(card);
            });
            listDiv.appendChild(section);
        }
    }

    // 3. 穩定版初始化與導覽
    function openViewer(index) {
        currentIndex = index;
        document.getElementById('gallery-view').style.display = 'none';
        const container = document.getElementById('viewer-container');
        container.style.display = 'block';
        uiVisible = true;
        toggleUI();

        // 關鍵修復：確保容器寬高已計算完成再初始化
        setTimeout(() => {
            if (!viewer) {
                initPSV(currentImages[currentIndex].data);
            } else {
                viewer.setPanorama(currentImages[currentIndex].data).then(() => {
                    // 切換圖片後重置視角
                    viewer.animate({ zoom: 30, speed: '2s' });
                });
            }
        }, 60); 
    }

    function initPSV(imageSrc) {
        viewer = new PhotoSphereViewer.Viewer({
            container: 'panorama',
            adapter: [PhotoSphereViewer.LittlePlanetAdapter],
            panorama: imageSrc,
            mousewheel: true,
            mousewheelSpeed: 2,
            minFov: 1,    
            maxFov: 170,  
            defaultZoomLvl: 30, // 初始縮放距離
            fisheye: 2,
            navbar: false
        });

        // 點擊事件：切換 UI 顯示
        viewer.addEventListener('click', () => {
            uiVisible = !uiVisible;
            toggleUI();
        });

        // 如果點擊過程中發生錯誤（例如圖片損毀），嘗試恢復
        viewer.addEventListener('ready', () => {
            console.log("Pano ready");
        }, { once: true });
    }

    function toggleUI() {
        document.querySelectorAll('.overlay-ui').forEach(el => {
            el.classList.toggle('hidden', !uiVisible);
        });
    }

    // 4. 控制逻辑
    document.getElementById('btn-back').onclick = () => {
        document.getElementById('gallery-view').style.display = 'block';
        document.getElementById('viewer-container').style.display = 'none';
        // 不銷毀 viewer 以便下次快速開啟，但可以停止渲染節省效能
        if (viewer) viewer.stopAutoRotate();
    };

    document.getElementById('prev-btn').onclick = (e) => {
        e.stopPropagation();
        if (currentIndex < currentImages.length - 1) {
            currentIndex++;
            viewer.setPanorama(currentImages[currentIndex].data);
        }
    };

    document.getElementById('next-btn').onclick = (e) => {
        e.stopPropagation();
        if (currentIndex > 0) {
            currentIndex--;
            viewer.setPanorama(currentImages[currentIndex].data);
        }
    };

    document.getElementById('btn-download').onclick = () => {
        const canvas = document.querySelector('#panorama canvas');
        const link = document.createElement('a');
        link.download = `TinyPlanet_${Date.now()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    };
</script>

</body>
</html>
