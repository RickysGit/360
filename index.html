<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360° 本地相簿 - 小星球版</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    
    <style>
        :root { --primary: #2196F3; }
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; }
        
        /* 列表介面 */
        #gallery-view { padding: 20px; }
        .upload-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .month-group { margin-bottom: 30px; }
        .month-title { border-left: 5px solid var(--primary); padding-left: 10px; margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .thumb-card { background: #fff; border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.2s; position: relative; }
        .thumb-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .thumb-card img { width: 100%; height: 100px; object-fit: cover; }
        .thumb-info { padding: 5px; font-size: 12px; text-align: center; }

        /* 全景閱讀器介面 */
        #viewer-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; }
        #panorama { width: 100%; height: 100%; }
        
        /* 控制元件 */
        .overlay-ui { position: absolute; z-index: 1001; transition: opacity 0.3s; }
        #btn-back { top: 20px; left: 20px; background: rgba(0,0,0,0.5); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; }
        #btn-download { top: 20px; right: 20px; background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; }
        .nav-controls { bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; }
        .nav-btn { background: rgba(255,255,255,0.8); border: none; padding: 15px; border-radius: 50%; cursor: pointer; font-size: 20px; }
        
        .hidden { opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

<div id="gallery-view">
    <div class="upload-section">
        <h2>我的 360° 全景相簿</h2>
        <input type="file" id="file-input" accept="image/*" style="display: none;">
        <button onclick="document.getElementById('file-input').click()" style="padding: 10px 20px; cursor: pointer;">上傳 360 圖片</button>
    </div>
    <div id="album-list"></div>
</div>

<div id="viewer-container">
    <div id="panorama"></div>
    <button id="btn-back" class="overlay-ui">← 返回列表</button>
    <button id="btn-download" class="overlay-ui">下載截圖</button>
    <div class="nav-controls overlay-ui">
        <button class="nav-btn" id="prev-btn">❮</button>
        <button class="nav-btn" id="next-btn">❯</button>
    </div>
</div>

<script>
    let db;
    let currentImages = [];
    let currentIndex = 0;
    let viewer = null;
    let uiVisible = true;

    // 1. 初始化 Database (IndexedDB)
    const request = indexedDB.open("PanoGalleryDB", 1);
    request.onupgradeneeded = e => {
        db = e.target.result;
        db.createObjectStore("photos", { keyPath: "id", autoIncrement: true });
    };
    request.onsuccess = e => {
        db = e.target.result;
        loadPhotos();
    };

    // 2. 處理檔案上傳
    document.getElementById('file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            const photoData = {
                name: file.name,
                data: event.target.result,
                timestamp: new Date().getTime(),
                monthKey: new Date().getFullYear() + "年" + (new Date().getMonth() + 1) + "月"
            };
            const transaction = db.transaction(["photos"], "readwrite");
            transaction.objectStore("photos").add(photoData);
            transaction.oncomplete = () => loadPhotos();
        };
        reader.readAsDataURL(file);
    });

    // 3. 讀取並顯示圖片列表
    function loadPhotos() {
        const transaction = db.transaction(["photos"], "readonly");
        const store = transaction.objectStore("photos");
        const request = store.getAll();

        request.onsuccess = () => {
            currentImages = request.result.reverse(); // 新的在前
            const listDiv = document.getElementById('album-list');
            listDiv.innerHTML = "";

            const groups = {};
            currentImages.forEach((img, index) => {
                if (!groups[img.monthKey]) groups[img.monthKey] = [];
                groups[img.monthKey].push({ ...img, originalIndex: index });
            });

            for (const month in groups) {
                const section = document.createElement('div');
                section.className = 'month-group';
                section.innerHTML = `<h3 class="month-title">${month}</h3><div class="grid"></div>`;
                const grid = section.querySelector('.grid');

                groups[month].forEach(photo => {
                    const card = document.createElement('div');
                    card.className = 'thumb-card';
                    card.innerHTML = `<img src="${photo.data}"><div class="thumb-info">${photo.name}</div>`;
                    card.onclick = () => openViewer(photo.originalIndex);
                    grid.appendChild(card);
                });
                listDiv.appendChild(section);
            }
        };
    }

    // 4. 開啟 360 閱覽器
    function openViewer(index) {
        currentIndex = index;
        document.getElementById('gallery-view').style.display = 'none';
        document.getElementById('viewer-container').style.display = 'block';
        initPannellum(currentImages[currentIndex].data);
    }

    function initPannellum(imageSrc) {
        if (viewer) viewer.destroy();
        viewer = pannellum.viewer('panorama', {
            "type": "equirectangular",
            "panorama": imageSrc,
            "autoLoad": true,
            "hfov": 100, // 初始視角
            "maxHfov": 150, // 縮放上限，越大越能看到小星球
            "minHfov": 30,
            "friction": 0.1,
            "showControls": false // 隱藏預設控制，我們自製
        });

        // 點擊切換 UI 顯示
        document.getElementById('panorama').onclick = () => {
            uiVisible = !uiVisible;
            document.querySelectorAll('.overlay-ui').forEach(el => {
                el.classList.toggle('hidden', !uiVisible);
            });
        };
    }

    // 5. 切換圖片與返回
    document.getElementById('btn-back').onclick = () => {
        document.getElementById('gallery-view').style.display = 'block';
        document.getElementById('viewer-container').style.display = 'none';
        if (viewer) viewer.destroy();
    };

    document.getElementById('prev-btn').onclick = () => {
        if (currentIndex < currentImages.length - 1) {
            currentIndex++;
            initPannellum(currentImages[currentIndex].data);
        }
    };

    document.getElementById('next-btn').onclick = () => {
        if (currentIndex > 0) {
            currentIndex--;
            initPannellum(currentImages[currentIndex].data);
        }
    };

    // 6. 截圖下載功能
    document.getElementById('btn-download').onclick = () => {
        const canvas = document.querySelector('#panorama canvas');
        if (canvas) {
            const link = document.createElement('a');
            link.download = `360_Capture_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        }
    };
</script>

</body>
</html>
