<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>360°相簿</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5/index.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/three/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/little-planet-adapter@5/index.min.js"></script>

    <style>
        :root { --primary: #007AFF; --bg: #f5f5f7; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; background: var(--bg); overflow-x: hidden; }
        
        /* 列表介面 */
        #gallery-view { padding: 20px; max-width: 1200px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .upload-btn { background: var(--primary); color: white; padding: 12px 24px; border-radius: 12px; cursor: pointer; border: none; font-weight: 600; }
        
        .month-group { margin-bottom: 40px; }
        .month-title { font-size: 1.5rem; font-weight: bold; border-left: 6px solid var(--primary); padding-left: 15px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .thumb-card { background: white; border-radius: 15px; overflow: hidden; cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .thumb-card:hover { transform: scale(1.05); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .thumb-card img { width: 100%; height: 130px; object-fit: cover; }
        .thumb-info { padding: 12px; font-size: 13px; color: #444; text-align: center; }

        /* 閱讀器介面 */
        #viewer-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; }
        #panorama { width: 100%; height: 100%; }
        
        .overlay-ui { position: absolute; z-index: 2001; transition: all 0.4s ease; opacity: 1; }
        .overlay-ui.hidden { opacity: 0; pointer-events: none; transform: translateY(10px); }
        
        #btn-back { top: 30px; left: 30px; background: rgba(0,0,0,0.7); color: white; border: none; padding: 12px 25px; border-radius: 50px; cursor: pointer; backdrop-filter: blur(10px); }
        #btn-download { top: 30px; right: 30px; background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 50px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 15px rgba(0,122,255,0.3); }
        
        .nav-controls { bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 50px; }
        .nav-btn { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.2); width: 65px; height: 65px; border-radius: 50%; cursor: pointer; font-size: 24px; backdrop-filter: blur(15px); }
        .nav-btn:active { background: rgba(255,255,255,0.4); }

        .zoom-hint { position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.5); font-size: 12px; letter-spacing: 1px; }
    </style>
</head>
<body>

<div id="gallery-view">
    <div class="header">
        <h1>360° 本地相簿</h1>
        <button class="upload-btn" onclick="document.getElementById('file-input').click()">＋ 上傳全景圖片</button>
        <input type="file" id="file-input" accept="image/*" style="display: none;">
    </div>
    <div id="album-list"></div>
</div>

<div id="viewer-container">
    <div id="panorama"></div>
    <button id="btn-back" class="overlay-ui">退出閱覽</button>
    <button id="btn-download" class="overlay-ui">保存當前畫面</button>
    
    <div class="zoom-hint overlay-ui">滾輪用力向後撥：觸發極小星球</div>
    
    <div class="nav-controls overlay-ui">
        <button class="nav-btn" id="prev-btn">❮</button>
        <button class="nav-btn" id="next-btn">❯</button>
    </div>
</div>

<script>
    let db;
    let currentImages = [];
    let currentIndex = 0;
    let viewer = null;
    let uiVisible = true;

    // 1. 初始化資料庫
    const request = indexedDB.open("UltraPanoGallery", 1);
    request.onupgradeneeded = e => {
        db = e.target.result;
        db.createObjectStore("photos", { keyPath: "id", autoIncrement: true });
    };
    request.onsuccess = e => {
        db = e.target.result;
        loadPhotos();
    };

    // 2. 處理上傳
    document.getElementById('file-input').addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = event => {
            const now = new Date();
            const photoData = {
                name: file.name,
                data: event.target.result,
                timestamp: now.getTime(),
                monthKey: `${now.getFullYear()}年${now.getMonth() + 1}月`
            };
            const tx = db.transaction("photos", "readwrite");
            tx.objectStore("photos").add(photoData);
            tx.oncomplete = () => loadPhotos();
        };
        reader.readAsDataURL(file);
    });

    function loadPhotos() {
        const tx = db.transaction("photos", "readonly");
        const store = tx.objectStore("photos");
        store.getAll().onsuccess = e => {
            currentImages = e.target.result.sort((a,b) => b.timestamp - a.timestamp);
            renderGallery();
        };
    }

    function renderGallery() {
        const listDiv = document.getElementById('album-list');
        listDiv.innerHTML = "";
        const groups = {};

        currentImages.forEach((img, idx) => {
            if (!groups[img.monthKey]) groups[img.monthKey] = [];
            groups[img.monthKey].push({ ...img, idx });
        });

        for (const month in groups) {
            const section = document.createElement('div');
            section.className = 'month-group';
            section.innerHTML = `<div class="month-title">${month}</div><div class="grid"></div>`;
            const grid = section.querySelector('.grid');

            groups[month].forEach(photo => {
                const card = document.createElement('div');
                card.className = 'thumb-card';
                card.innerHTML = `<img src="${photo.data}"><div class="thumb-info">${photo.name}</div>`;
                card.onclick = () => openViewer(photo.idx);
                grid.appendChild(card);
            });
            listDiv.appendChild(section);
        }
    }

    // 3. 核心：極致縮放的小星球閱覽器
    function openViewer(index) {
        currentIndex = index;
        document.getElementById('gallery-view').style.display = 'none';
        document.getElementById('viewer-container').style.display = 'block';
        uiVisible = true;
        toggleUI();
        initPSV(currentImages[currentIndex].data);
    }

    function initPSV(imageSrc) {
        if (viewer) viewer.destroy();

        viewer = new PhotoSphereViewer.Viewer({
            container: 'panorama',
            adapter: [PhotoSphereViewer.LittlePlanetAdapter],
            panorama: imageSrc,
            loadingImg: 'https://photo-sphere-viewer.js.org/assets/loader.gif',
            mousewheel: true,
            mousewheelSpeed: 2, // 提高縮放靈敏度
            
            // 強化的縮放範圍
            minFov: 1,    // 放大極限：可以縮放至極細微的點
            maxFov: 170,  // 縮小極限：170度視角會讓星球變得非常小且圓
            defaultZoomLvl: 0,
            fisheye: 2,   // 增強立體感
            
            navbar: false
        });

        viewer.addEventListener('click', () => {
            uiVisible = !uiVisible;
            toggleUI();
        });
    }

    function toggleUI() {
        document.querySelectorAll('.overlay-ui').forEach(el => {
            el.classList.toggle('hidden', !uiVisible);
        });
    }

    // 4. 交互控制
    document.getElementById('btn-back').onclick = () => {
        document.getElementById('gallery-view').style.display = 'block';
        document.getElementById('viewer-container').style.display = 'none';
        if (viewer) viewer.destroy();
    };

    document.getElementById('prev-btn').onclick = () => {
        if (currentIndex < currentImages.length - 1) {
            currentIndex++;
            viewer.setPanorama(currentImages[currentIndex].data);
        }
    };

    document.getElementById('next-btn').onclick = () => {
        if (currentIndex > 0) {
            currentIndex--;
            viewer.setPanorama(currentImages[currentIndex].data);
        }
    };

    document.getElementById('btn-download').onclick = () => {
        const canvas = document.querySelector('#panorama canvas');
        const link = document.createElement('a');
        link.download = `TinyPlanet_Art.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    };
</script>

</body>
</html>
