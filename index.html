<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ˆæ¥­ç´š 360Â° å°æ˜Ÿçƒç›¸ç°¿</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5/index.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/three/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/core@5/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@photo-sphere-viewer/little-planet-adapter@5/index.min.js"></script>

    <style>
        :root { --primary: #007AFF; --bg: #f5f5f7; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: var(--bg); color: #333; }
        
        /* åˆ—è¡¨ä»‹é¢ */
        #gallery-view { padding: 20px; max-width: 1200px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .upload-btn { background: var(--primary); color: white; padding: 12px 24px; border-radius: 12px; cursor: pointer; border: none; font-weight: 600; }
        
        .month-group { margin-bottom: 40px; }
        .month-title { font-size: 1.5rem; font-weight: bold; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .thumb-card { background: white; border-radius: 15px; overflow: hidden; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .thumb-card:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .thumb-card img { width: 100%; height: 120px; object-fit: cover; background: #eee; }
        .thumb-info { padding: 10px; font-size: 13px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* é–±è®€å™¨ä»‹é¢ */
        #viewer-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; }
        #panorama { width: 100%; height: 100%; }
        
        .overlay-ui { position: absolute; z-index: 2001; transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1); opacity: 1; }
        .overlay-ui.hidden { opacity: 0; pointer-events: none; }
        
        #btn-back { top: 30px; left: 30px; background: rgba(0,0,0,0.6); color: white; border: none; padding: 10px 20px; border-radius: 30px; cursor: pointer; backdrop-filter: blur(5px); }
        #btn-download { top: 30px; right: 30px; background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: 600; }
        
        .nav-controls { bottom: 40px; left: 50%; transform: translateX(-50%); display: flex; gap: 40px; align-items: center; }
        .nav-btn { background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); width: 60px; height: 60px; border-radius: 50%; cursor: pointer; font-size: 24px; backdrop-filter: blur(10px); }
        .nav-btn:hover { background: rgba(255,255,255,0.4); }

        /* å°æ˜Ÿçƒæ¨¡å¼æç¤º */
        .hint { position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.6); font-size: 12px; pointer-events: none; }
    </style>
</head>
<body>

<div id="gallery-view">
    <div class="header">
        <h1>360Â° å…¨æ™¯å›æ†¶</h1>
        <button class="upload-btn" onclick="document.getElementById('file-input').click()">ï¼‹ ä¸Šå‚³æ–°ç›¸ç‰‡</button>
        <input type="file" id="file-input" accept="image/*" style="display: none;">
    </div>
    <div id="album-list"></div>
</div>

<div id="viewer-container">
    <div id="panorama"></div>
    <button id="btn-back" class="overlay-ui">â† é€€å‡ºé–±è¦½</button>
    <button id="btn-download" class="overlay-ui">ğŸ’¾ æˆªåœ–ä¸‹è¼‰</button>
    
    <div class="hint overlay-ui">æ»¾è¼ªç¸®å°å¯è§¸ç™¼ Tiny Planet æ•ˆæœ</div>
    
    <div class="nav-controls overlay-ui">
        <button class="nav-btn" id="prev-btn">â®</button>
        <button class="nav-btn" id="next-btn">â¯</button>
    </div>
</div>

<script>
    let db;
    let currentImages = [];
    let currentIndex = 0;
    let viewer = null;
    let uiVisible = true;

    // 1. è³‡æ–™åº«åˆå§‹åŒ–
    const request = indexedDB.open("ProPanoGallery", 1);
    request.onupgradeneeded = e => {
        db = e.target.result;
        db.createObjectStore("photos", { keyPath: "id", autoIncrement: true });
    };
    request.onsuccess = e => {
        db = e.target.result;
        loadPhotos();
    };

    // 2. è™•ç†ä¸Šå‚³
    document.getElementById('file-input').addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = event => {
            const now = new Date();
            const photoData = {
                name: file.name,
                data: event.target.result,
                timestamp: now.getTime(),
                monthKey: `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ`
            };
            const tx = db.transaction("photos", "readwrite");
            tx.objectStore("photos").add(photoData);
            tx.oncomplete = () => loadPhotos();
        };
        reader.readAsDataURL(file);
    });

    // 3. è¼‰å…¥åˆ—è¡¨
    function loadPhotos() {
        const tx = db.transaction("photos", "readonly");
        const store = tx.objectStore("photos");
        store.getAll().onsuccess = e => {
            currentImages = e.target.result.sort((a,b) => b.timestamp - a.timestamp);
            renderGallery();
        };
    }

    function renderGallery() {
        const listDiv = document.getElementById('album-list');
        listDiv.innerHTML = "";
        const groups = {};

        currentImages.forEach((img, idx) => {
            if (!groups[img.monthKey]) groups[img.monthKey] = [];
            groups[img.monthKey].push({ ...img, idx });
        });

        for (const month in groups) {
            const section = document.createElement('div');
            section.className = 'month-group';
            section.innerHTML = `<div class="month-title">${month}</div><div class="grid"></div>`;
            const grid = section.querySelector('.grid');

            groups[month].forEach(photo => {
                const card = document.createElement('div');
                card.className = 'thumb-card';
                card.innerHTML = `<img src="${photo.data}"><div class="thumb-info">${photo.name}</div>`;
                card.onclick = () => openViewer(photo.idx);
                grid.appendChild(card);
            });
            listDiv.appendChild(section);
        }
    }

    // 4. é–‹å•Ÿ 360 é–±è¦½ï¼ˆæ ¸å¿ƒï¼šLittle Planet é©é…å™¨ï¼‰
    function openViewer(index) {
        currentIndex = index;
        document.getElementById('gallery-view').style.display = 'none';
        document.getElementById('viewer-container').style.display = 'block';
        uiVisible = true;
        toggleUI();
        initPSV(currentImages[currentIndex].data);
    }

    function initPSV(imageSrc) {
        if (viewer) viewer.destroy();

        viewer = new PhotoSphereViewer.Viewer({
            container: 'panorama',
            adapter: [PhotoSphereViewer.LittlePlanetAdapter], // ä½¿ç”¨å°æ˜Ÿçƒé©é…å™¨
            panorama: imageSrc,
            loadingImg: 'https://photo-sphere-viewer.js.org/assets/loader.gif',
            touchmoveTwoFingers: false,
            mousewheel: true,
            defaultZoomLvl: 0, // åˆå§‹ç‹€æ…‹
            fisheye: 2, // é€™æ˜¯é—œéµï¼šæ•¸å€¼è¶Šé«˜ï¼Œå°æ˜Ÿçƒçš„ç«‹é«”æ„Ÿè¶Šå¼·
            navbar: false // éš±è—é è¨­å°è¦½åˆ—ï¼Œä½¿ç”¨æˆ‘å€‘è‡ªè¨‚çš„
        });

        // é»æ“Šå±å¹•åˆ‡æ› UI
        viewer.addEventListener('click', () => {
            uiVisible = !uiVisible;
            toggleUI();
        });
    }

    function toggleUI() {
        document.querySelectorAll('.overlay-ui').forEach(el => {
            el.classList.toggle('hidden', !uiVisible);
        });
    }

    // 5. å°è¦½èˆ‡åŠŸèƒ½
    document.getElementById('btn-back').onclick = () => {
        document.getElementById('gallery-view').style.display = 'block';
        document.getElementById('viewer-container').style.display = 'none';
        if (viewer) viewer.destroy();
    };

    document.getElementById('prev-btn').onclick = () => {
        if (currentIndex < currentImages.length - 1) {
            currentIndex++;
            viewer.setPanorama(currentImages[currentIndex].data);
        }
    };

    document.getElementById('next-btn').onclick = () => {
        if (currentIndex > 0) {
            currentIndex--;
            viewer.setPanorama(currentImages[currentIndex].data);
        }
    };

    // 6. æˆªåœ–ä¸‹è¼‰ (ä½¿ç”¨ PSV å…§å»ºæ–¹æ³•)
    document.getElementById('btn-download').onclick = () => {
        const canvas = document.querySelector('#panorama canvas');
        const link = document.createElement('a');
        link.download = `TinyPlanet_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    };
</script>

</body>
</html>
